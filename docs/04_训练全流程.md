# 04 - 训练全流程

> 🎯 **学习目标**：从零开始完成第一次训练
> ⏱️ **预计时间**：40分钟（阅读）+ 训练时间
> 📌 **适合人群**：准备开始实战的学习者

---

## 快速导航

- [训练前准备](#第一部分训练前准备)
- [第一次训练](#第二部分第一次训练5x5)
- [理解输出](#第三部分理解训练输出)
- [监控进度](#第四部分监控训练进度)
- [常见问题](#第五部分常见问题faq)

---

## 第一部分：训练前准备

### ✅ 准备检查清单

在开始训练前，请确保：

```bash
□ Python 3.8+ 已安装
□ 已安装所有依赖 (pip install -r requirements.txt)
□ 环境检测通过 (python check_env.py)
□ 有足够磁盘空间（至少5GB）
□ 理解了基本概念（阅读过01、02、03文档）
```

### 🔍 环境检测

**第一步：运行环境检测**

```bash
cd Gomoku_RL
python check_env.py
```

**期望输出**：

```
============================================================
AlphaZero Gomoku - Environment Check
============================================================

Python Version: 3.10.x

Checking Python packages...
------------------------------------------------------------
✓ torch           2.7.1
✓ numpy           2.2.5
✓ matplotlib      3.10.5
✓ tqdm            4.67.1

============================================================
Device Information
============================================================
PyTorch Version: 2.7.1
CUDA Available: True/False
GPU: NVIDIA RTX 3080 (如果有)
Memory: 10.00 GB (如果有)
============================================================

Testing basic operations...
------------------------------------------------------------
✓ Using CPU/CUDA
✓ Tensor creation: OK
✓ Matrix multiplication: OK
✓ Neural network layers: OK
✓ Backward pass: OK

All tests passed! ✓
```

**如果有错误**：

| 错误 | 解决方案 |
|------|---------|
| ModuleNotFoundError: torch | `pip install torch` |
| CUDA不可用（Mac） | 正常，Mac用CPU训练 |
| CUDA不可用（Windows） | 安装CUDA驱动 |
| 其他导入错误 | `pip install -r requirements.txt` |

### 💾 磁盘空间检查

```bash
# Mac/Linux
df -h .

# Windows
dir
```

**需要空间**：
- 5x5训练：约500MB
- 10x10训练：约2GB
- 15x15训练：约5GB

### 📂 项目目录确认

```bash
ls -la
```

**应该看到**：
```
gomoku/          ← 游戏逻辑
alphazero/       ← 算法实现
configs/         ← 配置文件
utils/           ← 工具
train.py         ← 训练脚本
play.py          ← 对弈脚本
evaluate.py      ← 评估脚本
check_env.py     ← 环境检测
```

---

## 第二部分：第一次训练（5×5）

### 🎯 为什么从5×5开始？

- ✅ **快速验证**：几小时就能看到结果
- ✅ **低硬件要求**：CPU就能跑
- ✅ **学习流程**：理解完整训练过程
- ✅ **调试方便**：出问题容易发现

### 🚀 开始训练

#### 基础命令

```bash
python train.py --board_size 5
```

**就这么简单！** 程序会：
1. 加载5×5配置
2. 创建神经网络
3. 开始自我对弈和训练
4. 自动保存模型到 `models/5x5/`

#### 完整命令（带参数）

```bash
python train.py \
    --board_size 5 \        # 棋盘大小
    --iterations 20 \       # 训练20轮（默认100）
    --log_dir logs \        # 日志目录
    --cpu                   # 强制用CPU（可选）
```

#### 自定义训练轮数

```bash
# 快速测试（5轮，约30分钟）
python train.py --board_size 5 --iterations 5

# 标准训练（100轮，约6小时）
python train.py --board_size 5 --iterations 100
```

### ⏱️ 时间估算

**5×5棋盘，Mac CPU**：

| 配置 | 每轮时间 | 总时间（100轮） |
|------|---------|----------------|
| MCTS 200次 | ~3-4分钟 | ~5-6小时 |
| MCTS 100次 | ~2分钟 | ~3小时 |

**10×10棋盘，GPU**：

| 配置 | 每轮时间 | 总时间（200轮） |
|------|---------|----------------|
| MCTS 400次 | ~10分钟 | ~33小时 |

**15×15棋盘，GPU**：

| 配置 | 每轮时间 | 总时间（500轮） |
|------|---------|----------------|
| MCTS 800次 | ~20-30分钟 | ~7-10天 |

---

## 第三部分：理解训练输出

### 📊 启动信息

```
============================================================
AlphaZero Gomoku - Environment Check
============================================================
...
INFO: Logger initialized. Log file: logs/AlphaZero_5x5_20250116_153045.log
INFO: Loading configuration for 5x5 board...
INFO: Using device: cpu
INFO: Initializing game...
INFO: Creating neural network...

Network architecture:
  Board size: 5x5
  Channels: 64
  Residual blocks: 4
  Total parameters: 52,416

INFO: Initializing trainer...

Training configuration:
  Total iterations: 100
  Self-play games per iteration: 50
  MCTS simulations: 200
  Batch size: 32
  Learning rate: 0.001
  Checkpoint directory: models/5x5

============================================================
Starting training...
============================================================
```

**关键信息**：
- **网络参数数量**：5万参数（5×5很小）
- **每轮50局自我对弈**
- **MCTS每步200次模拟**
- **批大小32**

### 📈 训练循环输出

```
============================================================
Iteration 1/100
============================================================

[1/3] Generating self-play games...
Playing 50 self-play games...
  Generated 10/50 games
  Generated 20/50 games
  Generated 30/50 games
  Generated 40/50 games
  Generated 50/50 games
Applying data augmentation...
After augmentation: 12000 examples
Training buffer size: 12000

[2/3] Training neural network...
  Epoch 1/5: Loss = 2.1456
  Epoch 2/5: Loss = 1.9823
  Epoch 3/5: Loss = 1.8567
  Epoch 4/5: Loss = 1.7234
  Epoch 5/5: Loss = 1.6789

[3/3] Saving checkpoint...
Checkpoint saved: models/5x5/checkpoint_iter_1.pth

Iteration 1 completed. Avg Loss: 1.8974
```

**逐步解析**：

#### 步骤1：自我对弈

```
[1/3] Generating self-play games...
Playing 50 self-play games...
```

- AI自己和自己下50局棋
- 使用当前网络 + MCTS
- 平均每局约30步

```
After augmentation: 12000 examples
```

- 50局 × 平均30步 = 1500个原始样本
- 每个样本×8种对称 = 12000个训练样本

#### 步骤2：训练网络

```
[2/3] Training neural network...
  Epoch 1/5: Loss = 2.1456
  Epoch 2/5: Loss = 1.9823
  ...
  Epoch 5/5: Loss = 1.6789
```

- 用12000个样本训练网络
- 训练5个epoch（5遍）
- **Loss下降** = 网络在学习 ✅
- **Loss不变或上升** = 可能有问题 ⚠️

#### 步骤3：保存模型

```
[3/3] Saving checkpoint...
Checkpoint saved: models/5x5/checkpoint_iter_1.pth
```

- 每轮自动保存
- 保存位置：`models/5x5/`
- 包含：网络权重、优化器状态、配置

### 📉 Loss曲线解读

**正常训练**：

```
Iteration  1: Loss = 2.15  ← 初始很高
Iteration  5: Loss = 1.85  ← 快速下降
Iteration 10: Loss = 1.65
Iteration 20: Loss = 1.42
Iteration 50: Loss = 1.18  ← 逐渐收敛
Iteration 100: Loss = 0.95 ← 稳定
```

**图形化**：

```
Loss
  ↑
2.5|■
2.0| ■
1.5|  ■■
1.0|     ■■■■■■■■■■■■■■
0.5|
  0|_________________________→ Iteration
    0  20  40  60  80  100
```

**Loss意义**：
- **Loss > 2.0**：网络还很随机
- **Loss 1.5-2.0**：开始学习基本模式
- **Loss 1.0-1.5**：学会了合理策略
- **Loss < 1.0**：接近收敛，表现良好

### 🚨 异常情况识别

#### 情况1：Loss不下降

```
Iteration 1: Loss = 2.15
Iteration 2: Loss = 2.13
Iteration 3: Loss = 2.18  ← 没有下降！
```

**可能原因**：
- 学习率太低（改为0.01试试）
- MCTS模拟次数太少（增加到400）
- 网络太小（增加残差块）

#### 情况2：Loss突然上升

```
Iteration 10: Loss = 1.42
Iteration 11: Loss = 1.38
Iteration 12: Loss = 2.56  ← 突然飙升！
```

**可能原因**：
- 学习率太高（减小到0.0001）
- 数据缓冲区太小
- 罕见，通常会自动恢复

#### 情况3：Loss震荡

```
Iteration 10: Loss = 1.42
Iteration 11: Loss = 1.65
Iteration 12: Loss = 1.38
Iteration 13: Loss = 1.58
```

**可能原因**：
- 正常现象（小幅震荡可接受）
- 批量太小（增加batch_size）

---

## 第四部分：监控训练进度

### 📁 查看日志文件

**实时查看日志**：

```bash
# Mac/Linux
tail -f logs/AlphaZero_5x5_*.log

# Windows PowerShell
Get-Content logs/AlphaZero_5x5_*.log -Wait
```

**日志包含**：
- 详细的每轮信息
- 错误和警告
- 时间戳

### 💾 检查保存的模型

```bash
ls -lh models/5x5/
```

**应该看到**：

```
checkpoint_iter_1.pth       ← 第1轮
checkpoint_iter_2.pth       ← 第2轮
...
checkpoint_iter_10.pth      ← 第10轮
checkpoint_latest.pth       ← 最新（链接）
```

**模型文件大小**：
- 5×5：约500KB
- 10×10：约2MB
- 15×15：约10MB

### ⏸️ 中断和恢复训练

#### 优雅中断

```
正在训练时按 Ctrl+C

Training interrupted by user
Saving checkpoint...
Checkpoint saved: models/5x5/checkpoint_interrupted_15.pth
```

#### 恢复训练

```bash
python train.py \
    --board_size 5 \
    --resume models/5x5/checkpoint_iter_15.pth \
    --iterations 100  # 总共训练到100轮
```

**注意**：
- `--iterations 100` 是总轮数
- 从第15轮恢复，会继续到第100轮（还需85轮）

### 📊 简易进度监控脚本

创建 `monitor.sh`：

```bash
#!/bin/bash
# 监控训练进度

echo "Training Progress Monitor"
echo "========================="

# 模型数量
model_count=$(ls models/5x5/checkpoint_iter_*.pth 2>/dev/null | wc -l)
echo "Completed iterations: $model_count"

# 最新Loss
if [ -f logs/AlphaZero_5x5_*.log ]; then
    echo "Latest loss:"
    grep "Avg Loss" logs/AlphaZero_5x5_*.log | tail -5
fi

# 磁盘使用
echo ""
echo "Disk usage:"
du -sh models/5x5/
```

**使用**：

```bash
chmod +x monitor.sh
./monitor.sh
```

---

## 第五部分：常见问题FAQ

### 🐛 错误排查

#### Q1: `ModuleNotFoundError: No module named 'torch'`

**原因**：PyTorch未安装

**解决**：
```bash
pip install torch numpy tqdm matplotlib
```

#### Q2: `RuntimeError: CUDA out of memory`

**原因**：GPU显存不足

**解决方案**：

1. **减小batch_size**：编辑 `configs/config_5x5.py`
   ```python
   BATCH_SIZE = 16  # 原来32
   ```

2. **强制用CPU**：
   ```bash
   python train.py --board_size 5 --cpu
   ```

3. **减少自我对弈局数**：
   ```python
   NUM_SELF_PLAY_GAMES = 25  # 原来50
   ```

#### Q3: `ValueError: invalid literal for int()`

**原因**：命令行参数输入错误

**检查**：
```bash
# 错误
python train.py --board_size five  ✗

# 正确
python train.py --board_size 5  ✓
```

#### Q4: 训练非常慢

**原因分析**：

| 症状 | 原因 | 解决 |
|------|------|------|
| CPU 100%但很慢 | MCTS模拟太多 | 减少`NUM_SIMULATIONS` |
| 一局游戏很久 | 棋盘太大 | 从5×5开始 |
| GPU利用率低 | batch_size太小 | 增大`BATCH_SIZE` |

**优化建议**：

```python
# configs/config_5x5.py

# 快速训练（牺牲一点质量）
NUM_SIMULATIONS = 100        # 原来200
NUM_SELF_PLAY_GAMES = 25     # 原来50
NUM_EPOCHS = 3               # 原来5
```

#### Q5: Loss一直是NaN

**原因**：数值溢出

**解决**：
```python
# configs/config_5x5.py

# 降低学习率
LEARNING_RATE = 0.0001  # 原来0.001
```

### 💡 性能优化建议

#### Mac CPU用户

```python
# configs/config_5x5.py

# 优化CPU训练
NUM_SIMULATIONS = 100       # 减少模拟次数
NUM_SELF_PLAY_GAMES = 25    # 减少对弈局数
BATCH_SIZE = 16             # 减小批量
NUM_RES_BLOCKS = 3          # 减少网络层数
```

**预期**：每轮约2分钟，100轮约3小时

#### Windows GPU用户

```python
# configs/config_10x10.py

# 充分利用GPU
NUM_SIMULATIONS = 400
NUM_SELF_PLAY_GAMES = 100
BATCH_SIZE = 128            # 大批量
NUM_RES_BLOCKS = 8
```

**预期**：每轮约5-8分钟

### 🎯 训练策略建议

#### 新手首次训练

```bash
# 第1步：快速验证（5轮）
python train.py --board_size 5 --iterations 5

# 如果成功 →

# 第2步：短期训练（20轮）
python train.py --board_size 5 --iterations 20

# 如果Loss下降明显 →

# 第3步：完整训练（100轮）
python train.py --board_size 5 --iterations 100
```

#### 有经验用户

```bash
# 直接训练100轮
python train.py --board_size 5 --iterations 100

# 同时准备10×10
python train.py --board_size 10 --iterations 200
```

### 📝 训练日志分析

**查找关键信息**：

```bash
# 查看所有Loss
grep "Avg Loss" logs/*.log

# 查看错误
grep "ERROR" logs/*.log

# 查看警告
grep "WARNING" logs/*.log

# 统计完成的迭代
grep "Iteration.*completed" logs/*.log | wc -l
```

---

## 第六部分：训练后的下一步

### ✅ 训练完成检查

**确认训练成功**：

```bash
# 1. 检查模型文件
ls models/5x5/checkpoint_iter_*.pth | wc -l
# 应该有100个文件（如果训练100轮）

# 2. 查看最终Loss
grep "Avg Loss" logs/*.log | tail -1
# 应该 < 1.2

# 3. 模型文件完整
ls -lh models/5x5/checkpoint_latest.pth
# 应该约500KB
```

### 🎮 测试训练的模型

```bash
# 和AI对弈
python play.py \
    --checkpoint models/5x5/checkpoint_latest.pth \
    --board_size 5 \
    --human_first

# 评估vs随机
python evaluate.py \
    --checkpoint models/5x5/checkpoint_latest.pth \
    --board_size 5 \
    --num_games 50
```

**预期结果**：
- 训练20轮：vs随机胜率>80%
- 训练100轮：vs随机胜率>95%

### 🚀 进阶训练

#### 训练10×10（Windows GPU）

```bash
python train.py --board_size 10 --iterations 200
```

#### 训练15×15（强GPU）

```bash
python train.py --board_size 15 --iterations 500
```

### 📊 对比不同迭代的模型

```bash
# 比较iter_50 vs iter_100
python evaluate.py \
    --checkpoint models/5x5/checkpoint_iter_50.pth \
    --checkpoint2 models/5x5/checkpoint_iter_100.pth \
    --baseline model \
    --board_size 5 \
    --num_games 50
```

**预期**：后期迭代的模型胜率更高

---

## 🎓 总结检查单

训练前：
- [ ] 环境检测通过
- [ ] 理解基本概念
- [ ] 磁盘空间充足

训练中：
- [ ] Loss正常下降
- [ ] 定期查看日志
- [ ] 模型正常保存

训练后：
- [ ] 对弈测试
- [ ] 评估性能
- [ ] 尝试更大棋盘

---

**下一步**：
- 想理解代码细节 → [05_代码走读.md](./05_代码走读.md)
- 想做实战练习 → [06_实战练习.md](./06_实战练习.md)
- 遇到问题 → 回到[常见问题](#第五部分常见问题faq)
